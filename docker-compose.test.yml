version: "3.8"

services:
  clickhouse:
    image: clickhouse/clickhouse-server:23.3
    container_name: clickhouse-test
    volumes:
      - ./clickhouse/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d:ro
      - clickhouse_test_data:/var/lib/clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      - TZ=Europe/Paris
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opa_network

  agent:
    build: 
      context: ./agent
      dockerfile: Dockerfile
    container_name: opa-agent-test
    volumes:
      - opa_socket_test:/var/run
    depends_on:
      clickhouse:
        condition: service_healthy
    ports:
      - "8081:8080"
      - "8082:8082"
    environment:
      - CLICKHOUSE_URL=http://clickhouse:8123
      - SOCKET_PATH=/var/run/opa.sock
      - TRANSPORT_TCP=:9090
      - WS_PORT=8082
      - TZ=Europe/Paris
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opa_network

  mysql-test:
    image: mysql:8.0
    container_name: opa_mysql_test
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: test_db
      MYSQL_USER: test_user
      MYSQL_PASSWORD: test_password
    ports:
      - "3307:3306"
    volumes:
      - mysql_test_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_password"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - opa_network

  php-test:
    build:
      context: ./php-extension
      dockerfile: docker/Dockerfile.test
    container_name: opa_php_test
    volumes:
      - ./php-extension:/usr/src/opa:ro
      - ./php-extension/tests:/app/tests:ro
      - ./tests:/var/www/html/tests:ro
      - test_endpoints:/var/www/html/tests/apps:rw
      - opa_socket_test:/var/run
    working_dir: /app/tests
    depends_on:
      - agent
      - mysql-test
    networks:
      opa_network:
        aliases:
          - opa-agent
          - php-fpm
          - php-test
    environment:
      - DOCKER_CONTAINER=1
      - API_URL=http://agent:8080
      - BASE_URL=http://nginx-test
      - MYSQL_HOST=mysql-test
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=test_db
      - MYSQL_USER=test_user
      - MYSQL_PASSWORD=test_password
      - MYSQL_ROOT_PASSWORD=root_password
      - OPA_ENABLED=1
      - OPA_SOCKET_PATH=agent:9090
      - OPA_SAMPLING_RATE=1.0
      - OPA_DEBUG_LOG=1
      - OPA_ORGANIZATION_ID=default-org
      - OPA_PROJECT_ID=default-project
      - TZ=Europe/Paris
    # Start PHP-FPM in background and keep container running
    command: bash -c "php-fpm -D && tail -f /dev/null"

  nginx-test:
    image: nginx:alpine
    container_name: opa_nginx_test
    depends_on:
      - php-test
    volumes:
      - ./tests:/var/www/html/tests:ro
      - ./php-extension/tests:/var/www/html/php-extension/tests:ro
      - ./nginx/test-nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8090:80"
    networks:
      - opa_network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost/health"]
      interval: 2s
      timeout: 1s
      retries: 5

volumes:
  clickhouse_test_data:
  mysql_test_data:
  opa_socket_test:
  test_endpoints:

networks:
  opa_network:
    external: true

