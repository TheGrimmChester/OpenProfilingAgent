version: "3.8"

services:
  clickhouse:
    image: clickhouse/clickhouse-server:23.3
    container_name: clickhouse
    volumes:
      - ./clickhouse/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d:ro
      - clickhouse_data:/var/lib/clickhouse
    ports:
      - "9000:9000"
      - "8123:8123"
    environment:
      - TZ=Europe/Paris
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opa_network
    restart: unless-stopped

  agent:
    build: 
      context: ./agent
      dockerfile: Dockerfile
    container_name: opa-agent
    volumes:
      - opa_socket:/var/run
    depends_on:
      clickhouse:
        condition: service_healthy
    ports:
      - "2112:2112"
      - "8081:8080"
      - "8082:8082"
      - "10090:9090"
    environment:
      - CLICKHOUSE_URL=http://clickhouse:8123
      - SOCKET_PATH=/var/run/opa.sock
      - TRANSPORT_TCP=:9090
      - WS_PORT=${WS_PORT:-8082}
      - TZ=Europe/Paris
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opa_network
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: opa-prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    environment:
      - TZ=Europe/Paris
    depends_on:
      - agent
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opa_network
    restart: unless-stopped

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=
    container_name: opa-dashboard
    ports:
      - "3000:80"
    environment:
      - TZ=Europe/Paris
    depends_on:
      - agent
    networks:
      - opa_network
    profiles:
      - prod
    restart: unless-stopped

  dashboard-dev:
    image: node:18-alpine
    container_name: opa-dashboard-dev
    working_dir: /app
    volumes:
      - ./dashboard:/app
      - /app/node_modules
    ports:
      - "3000:3000"
    depends_on:
      - agent
    environment:
      - VITE_API_URL=${VITE_API_URL:-}
      - VITE_API_PROXY_TARGET=http://agent:8080
      - VITE_WS_PORT=${VITE_WS_PORT:-8082}
      - TZ=Europe/Paris
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    networks:
      - opa_network
    restart: unless-stopped

  # Symfony App Services
  mysql-symfony:
    image: mysql:8.0
    container_name: mysql-symfony
    environment:
      MYSQL_ROOT_PASSWORD: symfony_root_password
      MYSQL_DATABASE: symfony_db
      MYSQL_USER: symfony_user
      MYSQL_PASSWORD: symfony_password
    ports:
      - "3308:3306"
    volumes:
      - mysql_symfony_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-psymfony_root_password"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - opa_network
    restart: unless-stopped

  redis-symfony:
    image: redis:7-alpine
    container_name: redis-symfony
    ports:
      - "6380:6379"
    volumes:
      - redis_symfony_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - opa_network
    restart: unless-stopped

  symfony-php:
    build:
      context: ./php-extension
      dockerfile: docker/Dockerfile.test
    container_name: symfony-php
    volumes:
      - ./symfony-app:/var/www/symfony
      - ./symfony-app/docker/entrypoint.sh:/usr/local/bin/entrypoint.sh:ro
      - opa_socket:/var/run
    working_dir: /var/www/symfony
    depends_on:
      mysql-symfony:
        condition: service_healthy
      redis-symfony:
        condition: service_healthy
      agent:
        condition: service_healthy
    environment:
      - DATABASE_URL=mysql://symfony_user:symfony_password@mysql-symfony:3306/symfony_db?serverVersion=8.0&charset=utf8mb4
      - DATABASE_HOST=mysql-symfony
      - DATABASE_NAME=symfony_db
      - DATABASE_USER=symfony_user
      - DATABASE_PASSWORD=symfony_password
      - REDIS_URL=redis://redis-symfony:6379
      - APP_ENV=dev
      - APP_SECRET=dev_secret_key_change_in_production
      # OPA Extension - disabled by default, enable via .env file
      - OPA_ENABLED=${OPA_ENABLED:-0}
      - OPA_SOCKET_PATH=${OPA_SOCKET_PATH:-/var/run/opa.sock}
      - OPA_SAMPLING_RATE=${OPA_SAMPLING_RATE:-1.0}
      - OPA_DEBUG_LOG=${OPA_DEBUG_LOG:-0}
      - TZ=Europe/Paris
    networks:
      - opa_network
    restart: unless-stopped
    entrypoint: ["/usr/local/bin/entrypoint.sh"]
    # Start PHP-FPM
    command: ["php-fpm", "-F"]

  symfony-nginx:
    build:
      context: ./symfony-app
      dockerfile: docker/Dockerfile.nginx
    container_name: symfony-nginx
    volumes:
      - ./symfony-app:/var/www/symfony:ro
    ports:
      - "8080:80"
    depends_on:
      - symfony-php
    networks:
      - opa_network
    restart: unless-stopped

  symfony-apache:
    build:
      context: ./symfony-app
      dockerfile: docker/Dockerfile.apache
    container_name: symfony-apache
    volumes:
      - ./symfony-app:/var/www/symfony:ro
    ports:
      - "8081:80"
    depends_on:
      - symfony-php
    networks:
      - opa_network
    restart: unless-stopped
    profiles:
      - apache

volumes:
  clickhouse_data:
  prometheus_data:
  opa_socket:
  mysql_symfony_data:
  redis_symfony_data:

networks:
  opa_network:
    driver: bridge
    external: true